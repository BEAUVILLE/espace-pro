<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover">
<title>Mon Espace PRO ‚Äî DIGIY</title>

<style>
:root{
  --bg:#022c22;--bg2:#065f46;--card:#052e16;
  --accent:#facc15;--text:#e5e7eb;--muted:#9ca3af;
  --danger:#f97373;--ok:#22c55e;
  --line:rgba(148,163,184,.28);
  --glass:rgba(2,44,34,.35);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:
    radial-gradient(circle at top, rgba(250,204,21,.10), transparent 55%),
    linear-gradient(135deg,var(--bg),var(--bg2));
  color:var(--text);padding:20px;
}
.card{
  max-width:720px;width:100%;
  background:linear-gradient(145deg,rgba(5,46,22,.97),rgba(6,95,70,.96));
  border-radius:26px;border:1px solid rgba(15,118,110,.45);
  padding:22px;box-shadow:0 24px 60px rgba(0,0,0,.7);
}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px}
.left{display:flex;gap:12px;align-items:center}
.ico{
  width:52px;height:52px;border-radius:50%;
  display:grid;place-items:center;
  background:radial-gradient(circle at 30% 0,#facc15,transparent 55%);
  color:#022c22;font-size:24px;font-weight:900;
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 20px rgba(250,204,21,.15);
}
h1{font-size:14px;letter-spacing:.14em}
.subtitle{font-size:12px;color:var(--muted)}
.pill{
  border:1px solid var(--line);
  background:rgba(250,204,21,.12);
  padding:8px 12px;border-radius:999px;
  font-weight:900;font-size:12px;cursor:pointer;
  user-select:none;
}
.pill:hover{border-color:rgba(250,204,21,.55)}
.sep{height:1px;background:var(--line);margin:14px 0}
#status{font-size:14px;color:var(--muted);font-weight:800}
#mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}
.ok{color:var(--ok)} .err{color:var(--danger)}
.grid{display:grid;gap:10px;margin-top:14px}
.btn{
  width:100%;padding:14px;
  background:var(--glass);border:1px solid var(--line);
  border-radius:16px;color:var(--text);
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;font-weight:900;
}
.btn:hover{border-color:rgba(250,204,21,.6)}
.tag{
  padding:6px 10px;border-radius:999px;
  background:rgba(250,204,21,.12);
  border:1px solid rgba(250,204,21,.35);
  font-size:12px;font-weight:900;
}
.badge{
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(148,163,184,.28);
  background:rgba(0,0,0,.18);
  font-size:12px;font-weight:900;color:rgba(229,231,235,.92)
}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.smallbtn{
  flex:1;min-width:220px;
  padding:12px 14px;border-radius:14px;
  background:rgba(0,0,0,.18);
  border:1px solid var(--line);
  color:var(--text);
  font-weight:900;cursor:pointer;
}
.smallbtn:hover{border-color:rgba(250,204,21,.55)}
.note{
  margin-top:12px;
  padding:12px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.12);
  border-radius:14px;
  color:rgba(229,231,235,.86);
  font-size:12px;line-height:1.5
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="card">
  <div class="top">
    <div class="left">
      <div class="ico">ü¶Ö</div>
      <div>
        <h1>MON ESPACE PRO DIGIY</h1>
        <div class="subtitle" id="subtitle">JB BEAUVILLE ‚Ä¢ Acc√®s PRO</div>
      </div>
    </div>
    <div class="pill" id="logout">D√©connexion</div>
  </div>

  <div class="sep"></div>

  <div id="status">Chargement‚Ä¶</div>
  <div id="mini"></div>

  <div class="row" id="quick" style="display:none">
    <button class="smallbtn" id="btnInscription">‚ûï Ajouter un module</button>
    <button class="smallbtn" id="btnRefresh">üîÑ Actualiser</button>
  </div>

  <div class="grid" id="modules"></div>

  <div class="note">
    <b>R√®gle DIGIY :</b> si ton abonnement n‚Äôest pas actif, tu vois ‚ÄúActivation en cours‚Äù.
    Une fois activ√©, l‚Äôacc√®s est direct. <b>0% commission</b>.
  </div>
</div>

<script>
(async()=>{
  // =========================
  // CONFIG
  // =========================
  const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const ENTRY_URL = "https://beauville.github.io/inscription-digiy/";

  // Liens modules (mets les bons liens chez toi)
  const MODULES_URL = {
  DRIVER_PRO:  "https://beauville.github.io/digiy-pro-driver/",
  LOC:         "https://beauville.github.io/digiy-loc-pro-/",
  RESTO:       "https://beauville.github.io/digiy-resto-pro/",
  RESA:        "https://beauville.github.io/digiy-resa-pro/",
  MARKET:      "https://beauville.github.io/digiy-market-pro/",
  BUILD:       "https://beauville.github.io/digiy-build-pro/",
  POS:         "https://beauville.github.io/digiy-pos-pro/",
  JOBS:        "https://beauville.github.io/digiy-jobs-pro/",
  FRET:        "https://beauville.github.io/digiy-fret-pro/",
  FRET_CLIENT: "https://beauville.github.io/digiy-fret-client/",
  EXPLORER:    "https://beauville.github.io/digiy-explorer/"
};

  // RPC (tu as d√©j√† is_driver_active). Ici on veut un RPC universel.
  // Si tu n‚Äôas PAS encore: on fallback avec driver only.
  // -> id√©al: cr√©er rpc is_module_active(p_phone, p_module) c√¥t√© Supabase plus tard.
  async function isActiveFallback(phone, module){
    // fallback : driver only
    if(module === "DRIVER_PRO"){
      const { data, error } = await sb.rpc("is_driver_active", { p_phone: phone });
      if(error) return null;
      return !!data;
    }
    // modules autres : on ne bloque pas (on montre "Activation en cours" si tu veux strict)
    // Ici: on laisse "true" pour ne pas casser l‚Äôexp√©rience tant que RPC universel n‚Äôexiste pas.
    return true;
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const status = document.getElementById("status");
  const mini   = document.getElementById("mini");
  const grid   = document.getElementById("modules");
  const quick  = document.getElementById("quick");

  // =========================
  // Helpers phone
  // =========================
  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function getPhone(){
    const s = sessionStorage.getItem("digiy_driver_phone");
    if (s) return normPhone(s);

    const g = localStorage.getItem("digiy_phone");
    if (g) return normPhone(g);

    try{
      const a = JSON.parse(localStorage.getItem("digiy_driver_access_pin")||"null");
      if(a && a.phone) return normPhone(a.phone);
    }catch(_){}

    return null;
  }

  function goInscription(module){
    const u = new URL(ENTRY_URL);
    if(module) u.searchParams.set("module", String(module));
    u.searchParams.set("from", location.href);
    location.href = u.toString();
  }

  function clearSession(){
    // on vide ce qui cr√©e des boucles
    sessionStorage.removeItem("digiy_driver_phone");
    localStorage.removeItem("digiy_phone");
    localStorage.removeItem("digiy_driver_access_pin");
    // pro connu (si tu veux tout reset)
    localStorage.removeItem("digiy_known_pro");
  }

  function addCard(title, right, sub, onClick){
    const btn = document.createElement("div");
    btn.className = "btn";
    btn.innerHTML = `
      <div>
        <div style="font-size:14px">${title}</div>
        <div style="font-size:12px;opacity:.75;margin-top:4px">${sub||""}</div>
      </div>
      <span class="tag">${right||"ouvrir"}</span>
    `;
    btn.onclick = onClick;
    grid.appendChild(btn);
  }

  function badgeHtml(text){
    return `<span class="badge">${text}</span>`;
  }

  // =========================
  // Start
  // =========================
  const phone = getPhone();

  if(!phone){
    status.innerHTML = "<span class='err'>Aucun t√©l√©phone d√©tect√©</span>";
    mini.innerHTML = "Passe par l‚Äôinscription (porte unique) pour cr√©er ton acc√®s PRO.";
    grid.innerHTML = "";
    addCard("üìù Aller √† l‚Äôinscription DIGIY", "ouvrir", "Choisir module + tarifs + Wave", ()=>goInscription(""));
    return;
  }

  // pro connu
  try{ localStorage.setItem("digiy_known_pro","1"); }catch(_){}

  document.getElementById("subtitle").textContent = `JB BEAUVILLE ‚Ä¢ ${phone}`;
  quick.style.display = "flex";

  document.getElementById("btnInscription").onclick = ()=>goInscription("");
  document.getElementById("btnRefresh").onclick = ()=>location.reload();

  document.getElementById("logout").onclick = ()=>{
    clearSession();
    location.reload();
  };

  status.innerHTML = "<span class='ok'>Acc√®s PRO d√©tect√©</span>";
  mini.innerHTML = `T√©l√©phone : <b>${phone}</b><br>Choisis ton module üëë`;

  // =========================
  // Modules affich√©s
  // (tu peux changer la liste selon ce que tu veux montrer)
  // =========================
  const modulesToShow = [
  { code:"DRIVER_PRO",  label:"üöó DRIVER PRO",   hint:"Chauffeur ‚Äî 0% commission" },
  { code:"LOC",         label:"üè† LOC",          hint:"Locations ‚Äî paiement direct" },
  { code:"RESTO",       label:"üçΩÔ∏è RESTO",        hint:"Restaurant & caisse" },
  { code:"RESA",        label:"üìÖ R√âSA",         hint:"R√©servations (tables / services)" },
  { code:"MARKET",      label:"üõí MARKET",       hint:"Boutique & stock" },
  { code:"BUILD",       label:"üèóÔ∏è BUILD",        hint:"Artisans & devis" },
  { code:"POS",         label:"üí≥ POS",          hint:"Caisse boutique" },
  { code:"JOBS",        label:"üíº JOBS",         hint:"Emploi & recrutement" },
  { code:"EXPLORER",    label:"üß≠ EXPLORER",     hint:"Activit√©s & d√©couvertes" },
  { code:"FRET",        label:"üì¶ FRET PRO",     hint:"Transporteur / livreur" },
  { code:"FRET_CLIENT", label:"üì¶ FRET CLIENT",  hint:"Envoyer une marchandise" }
];

  grid.innerHTML = "";

  for(const m of modulesToShow){
    // check actif (fallback driver only)
    const ok = await isActiveFallback(phone, m.code);

    if(ok === null){
      addCard(
        `${m.label} ${badgeHtml("v√©rif indispo")}`,
        "ouvrir",
        m.hint,
        ()=>location.href = (MODULES_URL[m.code] || "#")
      );
      continue;
    }

    if(ok === false){
      addCard(
        `${m.label} ${badgeHtml("activation en cours")}`,
        "voir",
        "Ton paiement est en traitement. D√®s activation, acc√®s direct.",
        ()=>goInscription(m.code)
      );
      continue;
    }

    addCard(
      `${m.label} ${badgeHtml("actif")}`,
      "ouvrir",
      m.hint,
      ()=>location.href = (MODULES_URL[m.code] || "#")
    );
  }

})();
</script>
</body>
</html>
